#!/bin/bash

source cli-v1.sh
MODEL="claude-sonnet-4-20250514"
MAX_TOKENS=2000


# Check if there are staged changes
if ! git diff --cached --quiet; then
    # Get the staged diff
    DIFF_CONTENT=$(git diff --cached)

    # Check if diff is empty
    if [[ -z "$DIFF_CONTENT" ]]; then
        echo "No staged changes to commit."
        exit 1
    fi

    # Prepare prompt for Claude Sonnet
    PROMPT="Write a concise and descriptive git commit message for the following diff:\n\n$DIFF_CONTENT"
    TMP_JSON=$(mktemp)
    echo '{}' | jq --arg prompt "$PROMPT" --arg model "$MODEL" --argjson max_tokens "$MAX_TOKENS" \
        '.model=$model | .max_tokens=$max_tokens | .messages=[{"role":"user","content":$prompt}]' > "$TMP_JSON"
    BODY=$(cat "$TMP_JSON")
    rm "$TMP_JSON"
    # Call Claude Sonnet via Anthropic API (assumes API key is set in $ANTHROPIC_API_KEY)
    RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
      -H "x-api-key: $ANTHROPIC_API_KEY" \
      -H "anthropic-version: 2023-06-01" \
      -H "content-type: application/json" \
      -d "$BODY")

    # Extract the commit message from the response (assumes response contains "content")
    COMMIT_MSG=$(echo "$RESPONSE" | jq -r '.content // .choices[0].message.content // .messages[0].content // .messages[0].text // empty')

    # If extraction failed, print error
    if [[ -z "$COMMIT_MSG" ]]; then
        echo "Body: $BODY"
        echo "Response: $RESPONSE"
        echo "Failed to get commit message from Claude Sonnet."
        exit 1
    fi

    # Show the commit message and ask for confirmation
    echo "Suggested commit message:"
    echo "------------------------"
    echo "$COMMIT_MSG"
    echo "------------------------"
    read -p "Use this commit message? [Y/n]: " CONFIRM
    if [[ "$CONFIRM" =~ ^[Nn] ]]; then
        echo "Aborted."
        exit 1
    fi

    # Commit with the generated message
    git commit -m "$COMMIT_MSG"
else
    echo "No staged changes to commit."
    exit 1
fi
